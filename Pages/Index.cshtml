@page 
@model IndexModel 

@{ 
    ViewData["Title"] = "Home page"; 
} 

<div class="container mt-4">
    <h2>Dashboard</h2>
    <div class="container mt-4">

        <div class="row g-3">
            <!-- Open RMAs -->
            <div class="col-12 col-md-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="text-muted small">Open RMAs</div>
                        <div class="display-6 fw-semibold">@Model.OpenCount</div>
                        <div class="mt-1">
                            <span class="badge bg-success-subtle border border-success text-success">Live</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Closed in last 30 days -->
            <div class="col-12 col-md-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="text-muted small">Closed (Last 30 Days)</div>
                        <div class="display-6 fw-semibold">@Model.ClosedCount</div>
                        <div class="mt-1">
                            <span class="badge bg-secondary-subtle border border-secondary text-secondary">History</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Avg Resolution Days -->
            <div class="col-12 col-md-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="text-muted small">Avg Resolution Days</div>
                        <div class="display-6 fw-semibold">
                            @(Model.AvgResolutionDays?.ToString("0.0") ?? "—")
                        </div>
                        <div class="mt-1">
                            <span class="badge bg-info-subtle border border-info text-info">KPI</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr class="my-4" />
        <!-- KPI Chart -->
        <div class="row mt-4">
            <div class="col-12 col-md-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Open vs Closed (Last 30 Days)</h5>
                        <canvas id="kpiChart" height="110"></canvas>
                    </div>
                </div>
            </div>
        </div>

        @section Scripts {
            <script>
                const kpiCtx = document.getElementById('kpiChart').getContext('2d');
                const openCount = @Model.OpenCount;
                const closedCount = @Model.ClosedCount;

                new Chart(kpiCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Open', 'Closed (30d)'],
                        datasets: [{
                            data: [openCount, closedCount]
                        }]
                    },
                    options: {
                        plugins: { legend: { position: 'bottom' } },
                        cutout: '60%'
                    }
                });
            </script>
        }

        <!-- RMAs Aging Table -->


    <hr class="my-4" />

    <h3>Top Aging RMAs</h3>

    @if ((Model.AgingTop?.Count ?? 0) == 0)
    {
        <div class="alert alert-secondary" role="alert">
            No RMAs to display yet.
        </div>
    }
    else
    {
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>RMA #</th>
                    <th>Customer</th>
                    <th>Status</th>
                    <th>Opened</th>
                    <th>Age (days)</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var r in Model.AgingTop)
                {
                    <tr>
                        <td>
                            <a asp-page="/Rmas/Detail" asp-route-id="@r.id">@r.rma_number</a>
                        </td>
                        <td>@r.customer_name</td>
                        <td>@r.status</td>
                        <td>@r.opened_at.ToString("yyyy-MM-dd")</td>
                        <td>@r.age_days</td>
                    </tr>
                }
            </tbody>
        </table>
    }

</div>
